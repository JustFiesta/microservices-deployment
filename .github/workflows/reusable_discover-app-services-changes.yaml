name: Discover Changed Microservices

on:
  workflow_call:
    outputs:
      services:
        description: "JSON array of changed microservice names"
        value: ${{ jobs.discover-services.outputs.services }}

jobs:
  discover-services:
    name: Discover Changed Microservices
    runs-on: ubuntu-latest

    outputs:
      services: ${{ steps.discover.outputs.services }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Discover Changed Services
        id: discover
        run: |
          # Determine the base commit for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against the base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            echo "Comparing PR: ${BASE_SHA:0:7}...${HEAD_SHA:0:7}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            # For pushes, compare with previous commit
            # Check if this is the first commit (no parent)
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              BASE_SHA="HEAD~1"
              HEAD_SHA="HEAD"
              echo "Comparing push: previous commit vs current"
            else
              # First commit - compare with empty tree
              BASE_SHA="4b825dc642cb6eb9a060e54bf8d69288fbee4904" # Git empty tree SHA
              HEAD_SHA="HEAD"
              echo "First commit detected - checking all files"
            fi
          else
            echo "Unsupported event type: ${{ github.event_name }}"
            echo "services=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get list of changed files in microservices-demo/src/
          CHANGED_FILES=$(git diff --name-only ${BASE_SHA} ${HEAD_SHA} -- microservices-demo/src/ || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected in microservices-demo/src/"
            echo "services=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Extract unique service names from changed file paths
          # Expected path format: microservices-demo/src/<service-name>/...
          CHANGED_SERVICES=$(echo "$CHANGED_FILES" \
            | grep "^microservices-demo/src/" \
            | cut -d'/' -f3 \
            | sort -u \
            | grep -v "^$" || true)

          if [ -z "$CHANGED_SERVICES" ]; then
            echo "No service-level changes detected"
            echo "services=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Verify that changed directories have Dockerfiles
          VALID_SERVICES=()
          for SERVICE in $CHANGED_SERVICES; do
            SERVICE_PATH="microservices-demo/src/${SERVICE}"

            # Check if directory exists and has a Dockerfile
            if [ -d "$SERVICE_PATH" ] && [ -f "$SERVICE_PATH/Dockerfile" ]; then
              VALID_SERVICES+=("$SERVICE")
              echo " ${SERVICE} (has Dockerfile)"
            else
              echo "${SERVICE} (skipped - no Dockerfile)"
            fi
          done

          # Convert to JSON array
          if [ ${#VALID_SERVICES[@]} -eq 0 ]; then
            echo ""
            echo "No valid services with Dockerfiles found"
            SERVICES_JSON="[]"
          else
            SERVICES_JSON=$(printf '%s\n' "${VALID_SERVICES[@]}" | jq -R . | jq -sc .)
          fi

          echo ""
          echo "====================================="
          echo "  Changed services: $SERVICES_JSON"
          echo "====================================="
          echo "services=$SERVICES_JSON" >> "$GITHUB_OUTPUT"

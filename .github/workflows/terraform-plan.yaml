name: 'Terraform Plan'

on:
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'

env:
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID : ${{ secrets.AWS_ACCESS_KEY_ID  }}
  AWS_SECRET_ACCESS_KEY : ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  
  TF_VERSION: ${{ secrets.TERRAFORM_VERSION }}
  TF_INPUT: false
  TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
  
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    terraform-plan:
        name: 'Terraform Plan'
        runs-on: ubuntu-latest

        steps:
        - name: 'Checkout Repository'
          uses: actions/checkout@v5.0.0
    
        - name: 'Set up Terraform'
          uses: hashicorp/setup-terraform@v3.1.2
          with:
            terraform_version: ${{ env.TF_VERSION }}
    
        - name: 'Configure AWS Credentials'
          uses: aws-actions/configure-aws-credentials@v5.0.0
          with:
            aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ env.AWS_REGION }}
    
        - name: 'Terraform Init'
          id: tf-init
          working-directory: ./terraform
          run: |
            terraform init
    
        - name: Terraform Plan
          id: tf-plan
          working-directory: ./terraform
          run: |
            terraform plan -no-color

        - name: Add Plan Comment
          id: comment
          uses: actions/github-script@v6
          env:
            PLAN: "terraform\n${{ steps.tf-plan.outputs.stdout }}"
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
                const output = `#### Terraform Initialization ‚öôÔ∏è\`${{ steps.tf-init.outcome }}\`
                #### Terraform Plan üìñ\`${{ steps.tf-plan.outcome }}\`
            
                Plan details:  
                \`\`\`${process.env.PLAN}\`\`\`
                
                *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
                    
                github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: output
                })
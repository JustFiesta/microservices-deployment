name: Security Scans

on:
  schedule:
    # Run every Monday at 6:00 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch: # Allow manual trigger

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  discover-environments:
    name: Discover Terraform Environments
    uses: ./.github/workflows/reusable_discover-terraform-envs.yaml

  discover-services:
    name: Discover Microservices
    uses: ./.github/workflows/reusable_discover-app-services.yaml

  scan-ecr-images:
    name: Scan ECR Images - ${{ matrix.environment }}/${{ matrix.service }}
    runs-on: ubuntu-latest

    needs: [discover-environments, discover-services]
    if: ${{ needs.discover-services.outputs.services != '[]' && needs.discover-environments.outputs.environments != '[]' }}

    permissions:
      contents: read
      security-events: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.discover-environments.outputs.environments) }}
        service: ${{ fromJson(needs.discover-services.outputs.services) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get ECR Registry URL
        id: get-ecr-registry
        run: |
          # Convert environment name to uppercase for variable name
          ENV_UPPER=$(echo "${{ matrix.environment }}" | tr '[:lower:]' '[:upper:]')
          ECR_VAR_NAME="${ENV_UPPER}_ECR_REGISTRY"

          # Get ECR registry URL from GitHub variables
          ECR_REGISTRY_URL="${!ECR_VAR_NAME}"

          if [ -z "$ECR_REGISTRY_URL" ]; then
            echo "ERROR: GitHub variable ${ECR_VAR_NAME} is not set"
            echo "Please set ${ECR_VAR_NAME} in repository variables with the ECR registry URL"
            echo "ecr_registry_exists=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Using ECR registry: $ECR_REGISTRY_URL"
          echo "ecr_registry_url=$ECR_REGISTRY_URL" >> "$GITHUB_OUTPUT"
          echo "ecr_registry_exists=true" >> "$GITHUB_OUTPUT"

      - name: Get ECR Image URI
        id: get-image
        if: steps.get-ecr-registry.outputs.ecr_registry_exists == 'true'
        run: |
          ECR_REGISTRY_URL="${{ steps.get-ecr-registry.outputs.ecr_registry_url }}"
          REPO_NAME="${{ matrix.environment }}-${{ matrix.service }}"

          # Construct full image URI
          IMAGE_URI="${ECR_REGISTRY_URL}/${REPO_NAME}"

          # Check if repository exists in ECR and get latest image
          if aws ecr describe-repositories --repository-names "${REPO_NAME}" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            # Get the latest image tag
            LATEST_TAG=$(aws ecr describe-images \
              --repository-name "${REPO_NAME}" \
              --region ${{ env.AWS_REGION }} \
              --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
              --output text)

            if [ "$LATEST_TAG" != "None" ] && [ -n "$LATEST_TAG" ]; then
              FULL_IMAGE_URI="${IMAGE_URI}:${LATEST_TAG}"
              echo "Found image: $FULL_IMAGE_URI"
              echo "image_uri=$FULL_IMAGE_URI" >> "$GITHUB_OUTPUT"
              echo "image_exists=true" >> "$GITHUB_OUTPUT"
            else
              echo "No tagged images found in repository ${REPO_NAME}"
              echo "image_exists=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "Repository ${REPO_NAME} does not exist in ECR registry"
            echo "image_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Trivy Security Scan
        if: steps.get-image.outputs.image_exists == 'true'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: '${{ steps.get-image.outputs.image_uri }}'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.environment }}-${{ matrix.service }}.sarif'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM'
          timeout: '10m'

      - name: Upload Trivy SARIF to GitHub Security
        if: steps.get-image.outputs.image_exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.environment }}-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.environment }}-${{ matrix.service }}'

      - name: Generate Scan Summary
        if: steps.get-image.outputs.image_exists == 'true'
        run: |
          echo "### Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ steps.get-image.outputs.image_uri }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan completed. Check GitHub Security tab for detailed results." >> $GITHUB_STEP_SUMMARY

  scan-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: scan-ecr-images
    if: always()

    steps:
      - name: Generate Overall Summary
        run: |
          echo "### Weekly Security Scan Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All ECR images have been scanned with Trivy." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the results in the [GitHub Security tab](https://github.com/${{ github.repository }}/security/code-scanning)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

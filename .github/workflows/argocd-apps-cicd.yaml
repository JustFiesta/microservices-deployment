name: ArgoCD Apps Sync

on:
  pull_request:
    paths:
    - 'argocd/apps/**'
    - '.github/workflows/argocd-apps-sync.yaml'
  push:
    branches:
    - main
    paths:
    - 'argocd/apps/**'

permissions:
  contents: read
  pull-requests: write  # For posting PR comments

jobs:
  validate:
    name: Validate ArgoCD Application Manifests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'v1.28.0'

    - name: Validate YAML syntax
      run: |
        echo "Validating YAML files..."
        for file in argocd/apps/*.yaml; do
          echo "Checking $file"
          kubectl apply --dry-run=client -f "$file" || exit 1
        done

    - name: Check for required fields
      run: |
        echo "Checking ArgoCD Application manifests..."
        for file in argocd/apps/*.yaml; do
          echo "Validating $file"

          # Check if it's an Application resource
          kind=$(yq eval '.kind' "$file")
          if [ "$kind" != "Application" ]; then
            echo "ERROR: $file is not an Application resource (found: $kind)"
            exit 1
          fi

          # Check required fields
          repoURL=$(yq eval '.spec.source.repoURL' "$file")
          if [ "$repoURL" == "null" ] || [ -z "$repoURL" ]; then
            echo "ERROR: $file missing spec.source.repoURL"
            exit 1
          fi

          echo "✓ $file is valid"
        done

    - name: Install ArgoCD CLI
      run: |
        curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
        rm argocd-linux-amd64

    - name: Validate with ArgoCD
      run: |
        echo "Validating with ArgoCD CLI..."
        for file in argocd/apps/*.yaml; do
          echo "Validating $file with ArgoCD"
          argocd app validate -f "$file" || echo "Warning: $file validation failed (might be ok if ArgoCD server is not accessible)"
        done

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const files = fs.readdirSync('argocd/apps').filter(f => f.endsWith('.yaml'));

          let comment = '## ArgoCD Applications Validation\n\n';
          comment += `Found ${files.length} ArgoCD Application(s):\n\n`;

          for (const file of files) {
            const content = fs.readFileSync(`argocd/apps/${file}`, 'utf8');
            const lines = content.split('\n');
            const name = lines.find(l => l.includes('name:'))?.split(':')[1]?.trim();
            const env = lines.find(l => l.includes('environment:'))?.split(':')[1]?.trim();
            const namespace = lines.find(l => l.includes('namespace:'))?.split(':')[1]?.trim() || 'default';

            comment += `- **${file}**\n`;
            comment += `  - Application: \`${name}\`\n`;
            comment += `  - Environment: \`${env || 'N/A'}\`\n`;
            comment += `  - Target Namespace: \`${namespace}\`\n\n`;
          }

          comment += '\n✅ All manifests passed validation!\n';
          comment += '\n**Next Steps:**\n';
          comment += '- After merge, manifests will be automatically applied to the ArgoCD server\n';
          comment += '- Check ArgoCD UI for sync status\n';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  apply-to-argocd:
    name: Apply Applications to ArgoCD
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'v1.28.0'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-1

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name mbocak-microservices-demo-dev --region eu-west-1

    - name: Verify ArgoCD is running
      run: |
        kubectl get pods -n argocd
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

    - name: Apply ArgoCD Applications
      run: |
        echo "Applying ArgoCD Application manifests..."
        kubectl apply -f argocd/apps/ -n argocd

        echo ""
        echo "Applied Applications:"
        kubectl get applications -n argocd

    - name: Wait for Applications to be created
      run: |
        sleep 10
        echo "Current ArgoCD Applications:"
        kubectl get applications -n argocd -o wide

    - name: Get Application Status
      run: |
        echo "Application Health and Sync Status:"
        for app in $(kubectl get applications -n argocd -o jsonpath='{.items[*].metadata.name}'); do
          echo "---"
          echo "Application: $app"
          kubectl get application $app -n argocd -o jsonpath='{.status.health.status}' | xargs -I {} echo "Health: {}"
          kubectl get application $app -n argocd -o jsonpath='{.status.sync.status}' | xargs -I {} echo "Sync: {}"
        done


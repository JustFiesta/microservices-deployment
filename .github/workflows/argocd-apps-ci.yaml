name: ArgoCD Apps Sync

on:
  pull_request:
    paths:
    - 'argocd/**'
    - '.github/workflows/argocd-apps-cicd.yaml'
  push:
    branches:
    - main
    paths:
    - 'argocd/**'

permissions:
  contents: read
  pull-requests: write

env:
  KUBECTL_VERSION: 'v1.34.0'

jobs:
  validate:
    name: Validate ArgoCD Application Manifests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: ${{ env.KUBECTL_VERSION }}

    - name: Validate YAML syntax
      run: |
        echo "Validating YAML files..."
        for file in argocd/apps/*.yaml; do
          echo "Checking $file"
          kubectl apply --dry-run=client -f "$file" || exit 1
        done

    - name: Check for required fields
      run: |
        echo "Checking ArgoCD Application manifests..."
        for file in argocd/apps/*.yaml; do
          echo "Validating $file"

          # Check if it's an Application resource
          kind=$(yq eval '.kind' "$file")
          if [ "$kind" != "Application" ]; then
            echo "ERROR: $file is not an Application resource (found: $kind)"
            exit 1
          fi

          # Check required fields
          repoURL=$(yq eval '.spec.source.repoURL' "$file")
          if [ "$repoURL" == "null" ] || [ -z "$repoURL" ]; then
            echo "ERROR: $file missing spec.source.repoURL"
            exit 1
          fi

          echo "✓ $file is valid"
        done

    - name: Install ArgoCD CLI
      run: |
        curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
        rm argocd-linux-amd64

    - name: Validate with ArgoCD
      run: |
        echo "Validating with ArgoCD CLI..."
        for file in argocd/apps/*.yaml; do
          echo "Validating $file with ArgoCD"
          argocd app validate -f "$file" || echo "Warning: $file validation failed (might be ok if ArgoCD server is not accessible)"
        done

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const files = fs.readdirSync('argocd/apps').filter(f => f.endsWith('.yaml'));

          let comment = '## ArgoCD Applications Validation\n\n';
          comment += `Found ${files.length} ArgoCD Application(s):\n\n`;

          for (const file of files) {
            const content = fs.readFileSync(`argocd/apps/${file}`, 'utf8');
            const lines = content.split('\n');
            const name = lines.find(l => l.includes('name:'))?.split(':')[1]?.trim();
            const env = lines.find(l => l.includes('environment:'))?.split(':')[1]?.trim();
            const namespace = lines.find(l => l.includes('namespace:'))?.split(':')[1]?.trim() || 'default';

            comment += `- **${file}**\n`;
            comment += `  - Application: \`${name}\`\n`;
            comment += `  - Environment: \`${env || 'N/A'}\`\n`;
            comment += `  - Target Namespace: \`${namespace}\`\n\n`;
          }

          comment += '\n✅ All manifests passed validation!\n';
          comment += '\n**Next Steps:**\n';
          comment += '- After merge, manually apply manifests to ArgoCD:\n';
          comment += '  ```bash\n';
          comment += '  # Apply to argocd namespace\n';
          comment += '  kubectl apply -f argocd/ -n argocd\n';
          comment += '  \n';
          comment += '  # Or for specific environment:\n';
          comment += '  # kubectl apply -f argocd/apps/dev/ -n argocd\n';
          comment += '  ```\n';
          comment += '- Check ArgoCD UI for sync status\n';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

